---
import Logo from "./Logo.astro";

const links = [
  { href: "#what-we-will-offer", text: "Oferta" },
  { href: "#how-it-will-work", text: "Cómo funciona" },
  { href: "#products", text: "Productos" },
];
---

<header 
  id="main-header" 
  class="fixed top-0 left-0 w-full z-50 transition-all duration-300 bg-white shadow-sm"
  x-data="{
    isOpen: false,
    scrolled: false,
    init() {
      this.updateHeader();
      window.addEventListener('scroll', this.updateHeader.bind(this));
    },
    updateHeader() {
      this.scrolled = window.scrollY > 10;
    },
    toggle() {
      this.isOpen = !this.isOpen;
      document.body.style.overflow = this.isOpen ? 'hidden' : '';
      document.documentElement.classList.toggle('menu-open', this.isOpen);
    },
    close() {
      this.isOpen = false;
      document.body.style.overflow = '';
      document.documentElement.classList.remove('menu-open');
    },
    isActiveLink(href) {
      if (typeof window === 'undefined') return false;
      const currentPath = window.location.pathname + window.location.hash;
      return currentPath === href || (href !== '#' && currentPath.endsWith(href));
    },
    handleNavClick(event, targetId) {
      if (window.innerWidth >= 768) {
        event.preventDefault();
        const target = document.querySelector(targetId);
        if (target) {
          const headerOffset = 80;
          const elementPosition = target.getBoundingClientRect().top;
          const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

          window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
          });

          if (history.pushState) {
            history.pushState(null, null, targetId);
          } else {
            location.hash = targetId;
          }
        }
      }
      this.close();
    }
  }"
  x-bind:class="{ 'shadow-md': scrolled }"
  x-on:scroll.window="updateHeader"
  x-on:keydown.escape="close()"
>
  <!-- Mobile backdrop -->
  <div 
    x-show="isOpen"
    x-on:click="close()"
    class="md:hidden fixed inset-0 bg-white/80 z-40 transition-opacity duration-300 backdrop-blur-sm"
    x-bind:class="{ 'opacity-0 invisible': !isOpen, 'opacity-100': isOpen }"
    x-cloak
    x-transition:enter="ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
  ></div>

  <div class="container flex items-center justify-between h-20 relative z-50">
    <a 
      href="/" 
      class="hover:opacity-80 transition-opacity focus:outline-none focus-visible:ring-2 focus-visible:ring-plum-soft focus-visible:ring-offset-2 rounded-md p-1"
      x-on:click="close()"
    >
      <Logo class="h-8" />
      <span class="sr-only">Inicio</span>
    </a>
    
    <!-- Mobile menu button -->
    <button
      x-on:click="toggle()"
      class="md:hidden p-2 -mr-2 text-carbon/80 hover:text-plum-soft transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-plum-soft rounded-md"
      x-bind:aria-expanded="isOpen"
      aria-label="Menú de navegación"
    >
      <svg 
        class="w-6 h-6 transition-transform duration-300"
        x-bind:class="{'rotate-180': isOpen}"
        fill="none" 
        viewBox="0 0 24 24" 
        stroke="currentColor"
      >
        <path 
          x-show="!isOpen"
          stroke-linecap="round" 
          stroke-linejoin="round" 
          stroke-width="2" 
          d="M4 6h16M4 12h16M4 18h16"
        ></path>
        <path 
          x-show="isOpen"
          stroke-linecap="round" 
          stroke-linejoin="round" 
          stroke-width="2" 
          d="M6 18L18 6M6 6l12 12"
          class="origin-center"
        ></path>
      </svg>
    </button>

    <!-- Desktop Navigation -->
    <nav 
      class="hidden md:flex items-center gap-6 lg:gap-8"
      aria-label="Navegación principal"
    >
      {links.map((link) => (
        <a 
          href={link.href} 
          class="relative font-medium text-carbon/80 hover:text-sakura-medium transition-colors group"
          x-on:click="handleNavClick($event, link.href)"
          x-bind:class="{ 'text-sakura-medium': isActiveLink(link.href) }"
        >
          <span class="relative">
            {link.text}
            <span 
              class="absolute left-0 -bottom-1 w-0 h-0.5 bg-gradient-to-r from-sakura-light to-sakura-medium transition-all duration-300 group-hover:w-full"
              x-bind:class="{ 'w-full': isActiveLink(link.href) }"
            ></span>
          </span>
        </a>
      ))}
    </nav>

    <!-- Mobile Navigation -->
    <div 
      x-show="isOpen"
      class="md:hidden fixed top-20 right-0 w-full max-w-xs h-[calc(100vh-5rem)] bg-white/95 transform transition-transform duration-300 ease-in-out z-40 overflow-y-auto shadow-lg"
      x-bind:class="{ 'translate-x-0': isOpen, 'translate-x-full': !isOpen }"
      x-cloak
    >
      <div class="flex flex-col p-4 space-y-2">
        {links.map((link) => (
          <a 
            href={link.href}
            class="block px-4 py-3 text-lg font-medium text-carbon/90 hover:bg-plum-soft/10 hover:text-plum-soft rounded-lg transition-colors"
            x-on:click="close()"
            x-bind:class="{ 'text-plum-soft bg-plum-soft/5': isActiveLink(link.href) }"
          >
            {link.text}
          </a>
        ))}
      </div>
    </div>
  </div>
</header>

<style>
  [x-cloak] { display: none !important; }
  
  html {
    scroll-behavior: smooth;
    scroll-padding-top: 5rem;
  }
  
  @media (min-width: 768px) {
    html {
      margin-left: calc(100vw - 100%);
      margin-right: 0;
    }
  }
  
  .menu-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100%;
  }
</style>
